name: Deploy LLM Teach Me API

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.pnpm-store
        key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Run linting
      run: pnpm run lint || echo "‚ö†Ô∏è Linting has warnings but continuing..."
      continue-on-error: true

    - name: Build application
      run: pnpm run build

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.IMAGE_NAME }}:latest .
        docker build -t ${{ secrets.IMAGE_NAME }}:${{ github.sha }} .

    - name: Save and transfer Docker image
      run: |
        docker save ${{ secrets.IMAGE_NAME }}:latest | gzip > /tmp/llmteachme-api-image.tar.gz

        # Transfer image
        scp -i ~/.ssh/deploy_key /tmp/llmteachme-api-image.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/

        # Process configuration files with secrets
        cd deploy

        MONGO_URL="mongodb://admin:${{ secrets.MONGO_PASSWORD }}@llmteachme-mongodb:27017/llmteachme?authSource=admin"

        sed "s|PORT_PLACEHOLDER|${{ secrets.PORT }}|g" docker-compose.prod.yml > /tmp/docker-compose.llmteachme.yml
        sed -i "s|MONGO_URL_PLACEHOLDER|${MONGO_URL}|g" /tmp/docker-compose.llmteachme.yml
        sed -i "s|MONGO_PASSWORD_PLACEHOLDER|${{ secrets.MONGO_PASSWORD }}|g" /tmp/docker-compose.llmteachme.yml
        sed -i "s|GEMINI_API_KEY_PLACEHOLDER|${{ secrets.GEMINI_API_KEY }}|g" /tmp/docker-compose.llmteachme.yml
        sed -i "s|GEMINI_MODEL_PLACEHOLDER|${{ secrets.GEMINI_MODEL }}|g" /tmp/docker-compose.llmteachme.yml
        sed -i "s|JWT_SECRET_PLACEHOLDER|${{ secrets.JWT_SECRET }}|g" /tmp/docker-compose.llmteachme.yml
        sed -i "s|JWT_REFRESH_SECRET_PLACEHOLDER|${{ secrets.JWT_REFRESH_SECRET }}|g" /tmp/docker-compose.llmteachme.yml
        sed -i "s|CORS_ORIGIN_PLACEHOLDER|${{ secrets.CORS_ORIGIN }}|g" /tmp/docker-compose.llmteachme.yml

        # Transfer configuration files
        scp -i ~/.ssh/deploy_key /tmp/docker-compose.llmteachme.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/docker-compose.llmteachme.yml
        scp -i ~/.ssh/deploy_key init-mongo.js ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/init-mongo.js

    - name: Deploy to server
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          set -e

          echo 'üîÑ Loading Docker image...'
          gunzip -c /tmp/llmteachme-api-image.tar.gz | docker load
          rm /tmp/llmteachme-api-image.tar.gz

          echo 'üöÄ Deploying stack...'
          docker stack deploy -c docker-compose.llmteachme.yml ${{ secrets.STACK_NAME }}

          echo '‚è≥ Waiting for services to start...'
          sleep 15

          echo 'üìä Checking service status...'
          docker service ls | grep ${{ secrets.STACK_NAME }}

          echo 'üßπ Cleaning up old images...'
          docker image prune -f
          docker images | grep '${{ secrets.IMAGE_NAME }}' | grep -v latest | awk '{print \$3}' | head -5 | xargs -r docker rmi || true

          echo '‚úÖ Deployment completed successfully!'
        "

    - name: Deployment summary
      run: |
        echo "‚úÖ Deployment completed successfully!"
        echo "üì¶ Git commit: ${{ github.sha }}"
       

    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Deployment failed!"
        echo "üîç Check logs and server status"
        echo "üêõ Debug with: ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'docker service logs ${{ secrets.STACK_NAME }}_llmteachme-api --tail 100'"
